generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// =======================
// ENUMS
// =======================

enum UserRole {
  admin
  vendedor
  comprador
  repartidor
  soporte
}

enum OrderStatus {
  pendiente
  pagado
  enviado
  entregado
  cancelado
  devolucion
}

enum TicketPriority {
  baja
  media
  alta
  critica
}

enum TicketStatus {
  abierto
  en_proceso
  resuelto
  cerrado
}

enum PaymentStatus {
  pendiente
  aprobado
  rechazado
  reembolsado
}

// =======================
// MODELOS (Tablas)
// =======================

model User {
  id            String    @id @default(uuid())
  email         String    @unique @db.VarChar(255)
  password_hash String    @db.VarChar(255)
  full_name     String    @db.VarChar(100)
  role          UserRole  @default(comprador)
  phone         String?   @db.VarChar(20)
  is_active     Boolean   @default(true)

  // Relaciones
  products      Product[]        @relation("SellerProducts")
  addresses     Address[]
  ordersBought  Order[]          @relation("BuyerOrders")
  ordersCourier Order[]          @relation("CourierOrders")
  statusChanges OrderStatusHistory[]
  tickets       SupportTicket[]  @relation("UserTickets")
  assignedTickets SupportTicket[] @relation("AssignedSupport")
  reviews       Review[]
  ticketMessages TicketMessage[]  @relation("SenderMessages")

  @@map("users")
}

model Category {
  id          Int        @id @default(autoincrement())
  name        String     @db.VarChar(100)
  slug        String     @unique @db.VarChar(100)
  description String?    @db.Text
  parent_id   Int?
  
  // Relaciones
  parent      Category?  @relation("SubCategories", fields: [parent_id], references: [id])
  children    Category[] @relation("SubCategories")
  products    Product[]

  @@map("categories")
}

model Product {
  id          String    @id @default(uuid())
  seller_id   String
  category_id Int?
  name        String    @db.VarChar(150)
  slug        String    @unique @db.VarChar(150)
  description String?   @db.Text
  price       Decimal   @db.Decimal(10, 2)
  stock       Int       @default(0)
  is_active   Boolean   @default(true)

  created_at  DateTime  @default(now()) @db.Timestamp(0)
  updated_at  DateTime  @default(now()) @updatedAt @db.Timestamp(0)
  
  // Relaciones
  seller      User      @relation("SellerProducts", fields: [seller_id], references: [id])
  category    Category? @relation(fields: [category_id], references: [id])
  images      ProductImage[]
  orderItems  OrderItem[]
  reviews     Review[]

  @@map("products")
}

model ProductImage {
  id         String  @id @default(uuid())
  product_id String
  url        String  @db.Text

  // Relaciones
  product    Product @relation(fields: [product_id], references: [id])

  @@map("product_images")
}

model Address {
  id          String  @id @default(uuid())
  user_id     String
  street      String  @db.Text
  city        String  @db.Text
  state       String  @db.Text
  postal_code String  @db.Text
  country     String  @db.Text

  // Relaciones
  user        User    @relation(fields: [user_id], references: [id])
  orders      Order[]

  @@map("addresses")
}

model Order {
  id           String      @id @default(uuid())
  buyer_id     String
  courier_id   String?
  address_id   String
  total_amount Decimal     @default(0) @db.Decimal(12, 2)
  status       OrderStatus @default(pendiente)

  // Relaciones
  buyer        User        @relation("BuyerOrders", fields: [buyer_id], references: [id])
  courier      User?       @relation("CourierOrders", fields: [courier_id], references: [id])
  address      Address     @relation(fields: [address_id], references: [id])
  history      OrderStatusHistory[]
  items        OrderItem[]
  payments     Payment[]

  @@map("orders")
}

model OrderStatusHistory {
  id         String      @id @default(uuid())
  order_id   String
  status     OrderStatus
  changed_by String?
  changed_at DateTime    @default(now()) @db.Timestamp(0) // MySQL timestamp

  // Relaciones
  order      Order       @relation(fields: [order_id], references: [id])
  user       User?       @relation(fields: [changed_by], references: [id])

  @@map("order_status_history")
}

model OrderItem {
  id         String   @id @default(uuid())
  order_id   String
  product_id String
  quantity   Int
  unit_price Decimal  @db.Decimal(10, 2)
  created_at DateTime @default(now()) @db.Timestamp(0)

  // Relaciones
  order      Order    @relation(fields: [order_id], references: [id])
  product    Product  @relation(fields: [product_id], references: [id])

  @@unique([order_id, product_id])
  @@map("order_items")
}

model Payment {
  id         String        @id @default(uuid())
  order_id   String
  provider   String        @db.VarChar(50)
  status     PaymentStatus @default(pendiente)
  amount     Decimal       @db.Decimal(12, 2)
  created_at DateTime      @default(now()) @db.Timestamp(0)

  // Relaciones
  order      Order         @relation(fields: [order_id], references: [id])

  @@map("payments")
}

model SupportTicket {
  id          String         @id @default(uuid())
  user_id     String
  assigned_to String?
  subject     String         @db.VarChar(200)
  message     String         @db.Text // Mensaje inicial
  status      TicketStatus   @default(abierto)
  priority    TicketPriority @default(media)
  created_at  DateTime       @default(now()) @db.Timestamp(0)
  updated_at  DateTime       @default(now()) @updatedAt @db.Timestamp(0)

  // Relaciones existentes
  user        User           @relation("UserTickets", fields: [user_id], references: [id])
  assigned    User?          @relation("AssignedSupport", fields: [assigned_to], references: [id])
  
  // NUEVA RELACIÃ“N: Mensajes del chat
  chat_messages TicketMessage[] 
  
  @@map("support_tickets")
}

model Review {
  id         String   @id @default(uuid())
  product_id String
  user_id    String
  rating     Int
  comment    String?  @db.Text
  created_at DateTime @default(now()) @db.Timestamp(0)

  // Relaciones
  product    Product  @relation(fields: [product_id], references: [id])
  user       User     @relation(fields: [user_id], references: [id])

  @@unique([product_id, user_id])
  @@map("reviews")
}

model TicketMessage {
  id        String   @id @default(uuid())
  ticket_id String
  sender_id String   
  message   String   @db.Text
  created_at DateTime @default(now()) @db.Timestamp(0)

  // Relaciones
  ticket    SupportTicket @relation(fields: [ticket_id], references: [id], onDelete: Cascade)
  
  sender    User          @relation("SenderMessages", fields: [sender_id], references: [id]) 

  @@map("ticket_messages")
}